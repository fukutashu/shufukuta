<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Works / Shu Fukuta</title>
  <meta name="description" content="Works archive of Shu Fukuta." />

  <style>
    :root{
      --bg:#f4f2ee;
      --text:rgba(10,10,10,.90);
      --muted:rgba(10,10,10,.62);
      --faint:rgba(10,10,10,.42);

      --paper:rgba(255,255,255,.23);

      --line:rgba(0,0,0,.10);
      --line2:rgba(0,0,0,.055);

      --accent:rgba(60,92,78,.78);
      --accent2:rgba(60,92,78,.42);

      --max:1080px;
      --pad:clamp(16px,3vw,28px);
      --r:14px;

      --sans: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --grid-gap: 16px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      background: var(--bg);
      font-family: var(--sans);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* 背景 */
    .content-scrim{
      position:fixed;
      inset:0;
      background:
        radial-gradient(1200px 700px at 65% -10%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(900px 600px at 20% 20%, rgba(255,255,255,.35), transparent 55%),
        linear-gradient(to bottom, rgba(255,255,255,.00), rgba(255,255,255,.22));
      pointer-events:none;
      mix-blend-mode: normal;
      z-index:0;
    }

    /* 背景画像（ヘッダー） */
    body::before{
      content:"";
      position:fixed;
      top:0; left:0; right:0;
      height: 52vh;
      background:
        linear-gradient(to bottom, rgba(244,242,238,.25), rgba(244,242,238,1)),
        url("bg-board.jpg") center / cover no-repeat;
      filter: saturate(.95) contrast(.98);
      z-index:-1;
    }

    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding: calc(var(--pad)*1.2) var(--pad) calc(var(--pad)*2);
      position:relative;
      z-index:1;
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 16px;
      padding: 0 2px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap: 2px;
      line-height:1;
    }
    .name{
      font-size: 30px;
      font-weight: 520;
      letter-spacing: .2px;
    }
    .sub{
      font-family: var(--mono);
      font-size: 14px;
      color: var(--faint);
      text-transform: lowercase;
    }

    nav{
      display:flex;
      gap: 18px;
      align-items:baseline;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top: 8px;
    }
    nav a{
      position:relative;
      text-decoration:none;
      color: rgba(10,10,10,.78);
      font-family: var(--mono);
      font-size: 15px;
      padding: 6px 2px;
      transition: color .12s ease;
    }
    nav a:hover{ color: rgba(10,10,10,.92); }
    nav a.active{ color: rgba(10,10,10,.92); }
    nav a.active::before{
      content:"";
      position:absolute;
      left:0; right:0; bottom:-4px;
      height:1px;
      background: rgba(10,10,10,.22);
    }

    .panel{
      margin-top:18px;
      background: var(--paper);
      border: 1px solid rgba(0,0,0,.065);
      border-radius: var(--r);
      backdrop-filter: blur(3px);
      box-shadow:
        0 10px 30px rgba(0,0,0,.06),
        0 1px 0 rgba(255,255,255,.55) inset;
    }

    .in{ padding: calc(var(--pad)*1.1); }

    .topbar{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 16px;
    }
    .title{
      margin: 0;
      font-size: 28px;
      font-weight: 560;
      letter-spacing: .2px;
    }
    .hint{
      margin:0;
      font-family: var(--mono);
      font-size: 13px;
      color: rgba(10,10,10,.55);
    }

    .chips{
      margin-top: 14px;
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
    }
    .chip{
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.28);
      color: rgba(10,10,10,.72);
      font-family: var(--mono);
      font-size: 13px;
      padding: 8px 12px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, border-color .12s ease, transform .12s ease;
    }
    .chip:hover{ background: rgba(255,255,255,.42); transform: translateY(-1px); }
    .chip.active{
      border-color: rgba(60,92,78,.22);
      background: rgba(60,92,78,.10);
      color: rgba(10,10,10,.80);
    }

    .sortRow{
      margin-top: 16px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 12px;
      font-family: var(--mono);
      color: rgba(10,10,10,.60);
      font-size: 13px;
    }
    .sortSel{
      font-family: var(--mono);
      font-size: 14px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.34);
      color: rgba(10,10,10,.78);
      outline:none;
    }

    /* Masonry container */
    .grid{
      position: relative;
      width: 100%;
      /* gapは既存の --grid-gap をそのまま使う */
      min-height: 40vh;
      margin-top: 16px;
    }

    /* 子要素はJSで位置決めする */
    .work{
      position: absolute;
      left: 0;
      top: 0;
      will-change: transform;
      align-self: auto; /* 念のため */
    }

    /* 既存：hover浮きは維持 */
    .work__inner{
      border:1px solid rgba(0,0,0,.045);
      border-radius: 14px;
      background: rgba(255,255,255,.95);
      box-shadow: 0 1px 0 rgba(255,255,255,.35) inset;
      overflow: hidden;

      transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
      transform: translate3d(0,0,0);
      will-change: transform;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .work:hover .work__inner,
    .work:focus-visible .work__inner{
      transform: translate3d(0,-2px,0) scale(1.01);
      box-shadow:
        0 10px 25px rgba(0,0,0,.10),
        0 1px 0 rgba(255,255,255,.35) inset;
      border-color: rgba(0,0,0,.08);
    }

    .thumb{
      position:relative;
      display:block;
      width:100%;
      background: rgba(0,0,0,.03);
      border-radius: 14px;
      overflow: hidden;
    }
    .thumb img{
      width:100%;
      height:auto;
      display:block;
      filter: saturate(.92) contrast(1.02);
    }
    .thumb::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(to top, rgba(0,0,0,.08), transparent 45%);
      opacity:.08;
      pointer-events:none;
    }

    .cap{ padding: 12px 14px 14px; }
    .cap h3{
      margin: 0 0 8px;
      font-size: 16px;
      font-weight: 560;
      letter-spacing: .15px;
    }

    .meta{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      display:flex;
      flex-wrap:wrap;
      gap: 8px 12px;
      margin-bottom: 10px;
    }
    .desc{
      margin: 0;
      color: rgba(10,10,10,.76);
      font-size: 15px;
      line-height: 1.6;
      word-break: break-word;
    }

    .tags{
      margin-top: 10px;
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }
    .tag{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(10,10,10,.70);
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.40);
      padding: 7px 10px;
      border-radius: 999px;
    }

    footer{
      margin-top: 18px;
      padding: 0 2px;
      display:flex;
      justify-content:space-between;
      color: rgba(10,10,10,.55);
      font-family: var(--mono);
      font-size: 13px;
    }

    /* Lightbox（旧見た目維持） */
    .lb{
      position: fixed;
      inset: 0;
      z-index: 50;
      display:none;
    }
    .lb.open{ display:block; }
    .lb__bg{
      position:absolute; inset:0;
      background: rgba(10,10,10,.62);
      backdrop-filter: blur(2px);
    }
    .lb__panel{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      width: min(1080px, calc(100vw - 32px));
      height: min(720px, calc(100vh - 32px));
      border-radius: 18px;
      overflow:hidden;
      background: rgba(25,25,25,.86);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      display:flex;
      flex-direction:column;
    }
    .lb__top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      gap: 12px;
    }
    .lb__title{
      margin:0;
      font-size: 16px;
      font-weight: 560;
      color: rgba(255,255,255,.88);
      letter-spacing:.15px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .lb__btns{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .lb__btn{
      font-family: var(--mono);
      font-size: 14px;
      color: rgba(255,255,255,.80);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
    }
    .lb__btn:hover{ background: rgba(255,255,255,.14); }

    /* 旧仕様：上がメディア、下がテキスト（潰れない） */
    .lb__body{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .lb__media{
      flex: 0 0 auto;
      background: #fff; /* 選択メイン画像背後は白壁 */
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 40%;
      max-height: 56%;
      position:relative;
    }
    .lb__mediaInner{
      width: 100%;
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .lb__mediaInner img,
    .lb__mediaInner iframe{
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      display:block;
    }
    .lb__mediaInner iframe{
      width: 100%;
      height: 100%;
      border:0;
    }

    .lb__thumbs{
      position:absolute;
      right: 10px;
      top: 10px;
      bottom: 10px;
      width: 120px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      overflow:auto;
      padding: 0 2px;
    }
    .lb__thumbs::-webkit-scrollbar{ width: 10px; }
    .lb__thumb{
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 10px;
      overflow:hidden;
      cursor:pointer;
      background:#fff;
    }
    .lb__thumb img{
      width:100%;
      height:auto;
      display:block;
    }
    .lb__thumb.active{
      outline: 2px solid rgba(60,92,78,.55);
      outline-offset: 2px;
    }

    .lb__text{
      flex: 1 1 auto;
      min-height:0;
      overflow:auto; /* 長文は下段スクロール */
      padding: 16px;
      color: rgba(255,255,255,.86);
      font-size: 14px;
      line-height: 1.65;
    }
    .lb__text .meta{
      color: rgba(255,255,255,.70);
      margin-bottom: 12px;
    }
    .lb__text .tags .tag{
      color: rgba(255,255,255,.80);
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
    }

    /* 1100px以上は3列（既存） */
    @media (min-width: 1100px){
      .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    /* ✅ スマホ調整：520px以下 */
    @media (max-width: 520px){
      :root{ --grid-gap: 10px; }

      /* 画面ギリギリに寄せる（スマホのみ） */
      .wrap{
        padding-left: 6px !important;
        padding-right: 6px !important;
      }
      .in{
        padding: 12px !important;
      }

      /* 見た目は変えずに2列へ（列数はJSも2にしている） */
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }

      /* 一覧は「画像＋タイトル」だけ */
      .meta, .desc, .tags{ display:none !important; }

      .cap{ padding: 10px 12px 12px; }
      .cap h3{ font-size: 15px; margin: 0; }
    }
  </style>
</head>

<body>
  <div class="content-scrim" aria-hidden="true"></div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="name">Shu Fukuta</div>
        <div class="sub">works</div>
      </div>

      <nav>
        <a href="index.html">cv</a>
        <a class="active" href="works.html">works</a>
        <a href="exhibitions.html">exhibitions</a>
        <a href="blog.html">blog</a>
        <a href="contact.html">contact</a>
      </nav>
    </header>

    <section class="panel">
      <div class="in">
        <div class="topbar">
          <h1 class="title">Works</h1>
          <p class="hint">edit: data/works.json</p>
        </div>

        <div class="chips" id="chips"></div>

        <div class="sortRow" aria-label="sort">
          <span>sort</span>
          <select id="sortSel" class="sortSel">
            <option value="custom">custom</option>
            <option value="year_desc">year (new → old)</option>
            <option value="year_asc">year (old → new)</option>
          </select>
        </div>

        <div class="grid" id="grid"></div>
      </div>
    </section>

    <footer>
      <div>© Shu Fukuta</div>
      <div>works</div>
    </footer>
  </div>

  <!-- Lightbox -->
  <div class="lb" id="lb" aria-hidden="true">
    <div class="lb__bg" id="lbBg"></div>
    <div class="lb__panel" role="dialog" aria-modal="true" aria-label="work detail">
      <div class="lb__top">
        <h2 class="lb__title" id="lbTitle">title</h2>
        <div class="lb__btns">
          <button class="lb__btn" id="lbLinkBtn" type="button">link</button>
          <button class="lb__btn" id="lbCloseBtn" type="button">close</button>
        </div>
      </div>

      <div class="lb__body">
        <div class="lb__media">
          <div class="lb__mediaInner" id="lbMedia"></div>
          <div class="lb__thumbs" id="lbThumbs" aria-label="thumbnails"></div>
        </div>
        <div class="lb__text" id="lbText"></div>
      </div>
    </div>
  </div>

  <script>
  const DATA_URL = "data/works.json";

  const gridEl = document.getElementById("grid");
  const chipsEl = document.getElementById("chips");
  const sortSel = document.getElementById("sortSel");

  const lb = document.getElementById("lb");
  const lbBg = document.getElementById("lbBg");
  const lbCloseBtn = document.getElementById("lbCloseBtn");
  const lbTitle = document.getElementById("lbTitle");
  const lbMedia = document.getElementById("lbMedia");
  const lbThumbs = document.getElementById("lbThumbs");
  const lbText = document.getElementById("lbText");
  const lbLinkBtn = document.getElementById("lbLinkBtn");

  let allWorks = [];
  let filtered = [];
  let activeTag = "all";
  let activeSort = "custom";
  let activeIndex = -1;

  const getGap = () => {
    const g = getComputedStyle(document.documentElement).getPropertyValue('--grid-gap').trim();
    const n = parseFloat(g);
    return Number.isFinite(n) ? n : 16;
  };

  const getCols = () => {
    const w = window.innerWidth;
    if (w <= 520) return 2;     // ← スマホは2列（Pinterest寄せ）
    if (w >= 1100) return 3;
    return 2;
  };

  function layout(){
    const items = Array.from(gridEl.querySelectorAll('.work'));
    if(!items.length) {
      gridEl.style.height = "0px";
      return;
    }

    const cols = getCols();
    const gap = getGap();
    const cw = gridEl.clientWidth;

    // 列幅
    const colW = (cw - gap * (cols - 1)) / cols;

    // 各列の現在の高さ
    const heights = new Array(cols).fill(0);

    // 位置決め
    items.forEach(item => {
      item.style.width = `${colW}px`;

      // 高さ計測（innerの実寸）
      const inner = item.querySelector('.work__inner') || item;
      const h = inner.getBoundingClientRect().height;

      // 一番低い列に置く
      let col = 0;
      for(let i=1;i<cols;i++){
        if(heights[i] < heights[col]) col = i;
      }

      const x = col * (colW + gap);
      const y = heights[col];

      item.style.transform = `translate3d(${x}px, ${y}px, 0)`;

      heights[col] = y + h + gap;
    });

    const maxH = Math.max(...heights) - gap;
    gridEl.style.height = `${Math.max(0, maxH)}px`;
  }

  // リサイズで再レイアウト
  let raf = 0;
  function schedule(){
    cancelAnimationFrame(raf);
    raf = requestAnimationFrame(layout);
  }
  window.addEventListener('resize', schedule, { passive:true });

  function uniq(arr){
    return Array.from(new Set(arr.filter(Boolean)));
  }

  function buildChips(){
    const tags = uniq(allWorks.flatMap(w => w.tags || []));
    const ordered = ["all", ...tags];
    chipsEl.innerHTML = "";
    ordered.forEach(tag=>{
      const b = document.createElement("button");
      b.className = "chip" + (tag===activeTag ? " active" : "");
      b.type = "button";
      b.textContent = tag;
      b.addEventListener("click", ()=>{
        activeTag = tag;
        Array.from(chipsEl.querySelectorAll(".chip")).forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        applyFilters();
      });
      chipsEl.appendChild(b);
    });
  }

  function sortWorks(list){
    if(activeSort === "year_desc"){
      return [...list].sort((a,b)=>(Number(b.year)||0)-(Number(a.year)||0));
    }
    if(activeSort === "year_asc"){
      return [...list].sort((a,b)=>(Number(a.year)||0)-(Number(b.year)||0));
    }
    // custom
    return [...list];
  }

  function applyFilters(){
    const base = activeTag==="all"
      ? allWorks
      : allWorks.filter(w => (w.tags||[]).includes(activeTag));

    filtered = sortWorks(base);
    renderGrid();
  }

  function renderGrid(){
    gridEl.innerHTML = "";

    filtered.forEach((w, idx)=>{
      const a = document.createElement("a");
      a.className = "work";
      a.href = "#";
      a.setAttribute("data-index", String(idx));
      a.addEventListener("click", (ev)=>{
        ev.preventDefault();
        openLightbox(idx);
      });

      const inner = document.createElement("div");
      inner.className = "work__inner";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      const img = document.createElement("img");
      img.src = w.image;
      img.alt = w.title || "";
      img.loading = "lazy";
      img.decoding = "async";
      thumb.appendChild(img);

      const cap = document.createElement("div");
      cap.className = "cap";

      const h = document.createElement("h3");
      h.textContent = w.title || "(untitled)";

      const meta = document.createElement("div");
      meta.className = "meta";
      [w.year, w.medium, w.size].filter(Boolean).forEach(v=>{
        const s = document.createElement("span");
        s.textContent = v;
        meta.appendChild(s);
      });

      const desc = document.createElement("p");
      desc.className = "desc";
      desc.textContent = w.desc || "";

      const tagsBox = document.createElement("div");
      tagsBox.className = "tags";
      (w.tags||[]).forEach(t=>{
        const sp = document.createElement("span");
        sp.className = "tag";
        sp.textContent = t;
        tagsBox.appendChild(sp);
      });

      cap.appendChild(h);
      cap.appendChild(meta);
      cap.appendChild(desc);
      cap.appendChild(tagsBox);

      inner.appendChild(thumb);
      inner.appendChild(cap);

      a.appendChild(inner);
      gridEl.appendChild(a);

      // 画像読み込み後に再レイアウト
      img.addEventListener("load", schedule, { once:true });
      img.addEventListener("error", schedule, { once:true });
    });

    requestAnimationFrame(()=>{
      schedule();
    });
  }

  function openLightbox(index){
    activeIndex = index;
    const w = filtered[index];
    if(!w) return;

    lb.classList.add("open");
    lb.setAttribute("aria-hidden","false");

    lbTitle.textContent = w.title || "(untitled)";
    lbMedia.innerHTML = "";
    lbThumbs.innerHTML = "";
    lbText.innerHTML = "";

    // linkボタン
    const link = w.link || "";
    if(link){
      lbLinkBtn.style.display = "";
      lbLinkBtn.onclick = ()=> window.open(link, "_blank", "noopener");
    }else{
      lbLinkBtn.style.display = "none";
      lbLinkBtn.onclick = null;
    }

    // メディア（YouTube優先）
    let currentSrc = "";
    const images = (w.images && w.images.length) ? w.images : (w.image ? [w.image] : []);
    const yt = w.youtube || "";

    const setMain = (src) => {
      currentSrc = src;
      lbMedia.innerHTML = "";
      if(src && src.startsWith("http") && (src.includes("youtube.com") || src.includes("youtu.be"))){
        const iframe = document.createElement("iframe");
        iframe.src = src;
        iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
        iframe.allowFullscreen = true;
        lbMedia.appendChild(iframe);
      }else if(src){
        const im = document.createElement("img");
        im.src = src;
        im.alt = w.title || "";
        lbMedia.appendChild(im);
      }
    };

    // 右側のサムネ群（YouTube作品でも必ず画像サムネ群が出る）
    images.forEach((src, i)=>{
      const d = document.createElement("div");
      d.className = "lb__thumb" + (i===0 ? " active" : "");
      const im = document.createElement("img");
      im.src = src;
      im.alt = (w.title || "") + " " + (i+1);
      d.appendChild(im);
      d.addEventListener("click", ()=>{
        Array.from(lbThumbs.querySelectorAll(".lb__thumb")).forEach(x=>x.classList.remove("active"));
        d.classList.add("active");
        setMain(src);
      });
      lbThumbs.appendChild(d);
    });

    // 初期メイン：YouTubeがあるならYouTube、なければ1枚目
    if(yt){
      setMain(yt);
      // active表示は一旦1枚目に残す（右に群が出ることが重要）
    }else{
      setMain(images[0] || "");
    }

    // テキスト
    const meta = document.createElement("div");
    meta.className = "meta";
    [w.year, w.medium, w.size].filter(Boolean).forEach(v=>{
      const s = document.createElement("span");
      s.textContent = v;
      meta.appendChild(s);
    });

    const desc = document.createElement("div");
    desc.textContent = w.desc || "";

    const tags = document.createElement("div");
    tags.className = "tags";
    (w.tags||[]).forEach(t=>{
      const sp = document.createElement("span");
      sp.className = "tag";
      sp.textContent = t;
      tags.appendChild(sp);
    });

    lbText.appendChild(meta);
    lbText.appendChild(desc);
    lbText.appendChild(tags);
  }

  function closeLightbox(){
    lb.classList.remove("open");
    lb.setAttribute("aria-hidden","true");
    activeIndex = -1;
  }

  lbBg.addEventListener("click", closeLightbox);
  lbCloseBtn.addEventListener("click", closeLightbox);
  window.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && lb.classList.contains("open")) closeLightbox();
  });

  sortSel.addEventListener("change", ()=>{
    activeSort = sortSel.value;
    applyFilters();
  });

  async function init(){
    const res = await fetch(DATA_URL, { cache:"no-store" });
    const data = await res.json();
    allWorks = data.works || [];
    buildChips();
    applyFilters();
  }

  init().catch(err=>{
    console.error(err);
    gridEl.innerHTML = "<p style='font-family:var(--mono);color:rgba(10,10,10,.6)'>failed to load data/works.json</p>";
  });
  </script>
</body>
</html>